---
- name: Playbook to create Execution Environment
  hosts: localhost
  gather_facts: false
  vars:
    # ee_registry_dest: index.docker.io/r3dact3d
    # ee_registry_username: r3dact3d
    # ee_registry_password:
    # ee_registry_dest: quay.io/brthomps
    # ee_registry_username: brthomps
    ee_ah_host: galaxy.ansible.com
    # ee_ah_token:
    ee_builder_dir_clean: false
    builder_dir: "."
    ee_version: 3
    ee_list:
      - name: ee_builder
        tag: 3-28-2024
        base_image: quay.io/ansible/ansible-runner:latest
        dependencies:
          ansible_core:
            package_pip: ansible-core==2.13.13
          ansible_runner:
            package_pip: ansible-runner
          system:
            - python-requests
            - python-pyyaml
          python:
            - pytz
            - python-dateutil
            - awxkit
          galaxy: 
            collections:
              - name: awx.awx
                source: https://galaxy.ansible.com
              - name: containers.podman
                source: https://galaxy.ansible.com
              - name: community.general
                source: https://galaxy.ansible.com
          
        build_steps:
          prepend_final:
            - RUN whoami
            - RUN cat /etc/os-release
          append_final:
            - RUN echo This is a post-install command!

  # This pre-task section is provided because older environment or
  # environments like build pipelines may not have ansible-builder
  # pre-installed. This is a good place to install other dependencies
  # that need to be in the build pipeline its self not in the final artifact.
  pre_tasks:
    - name: Install ansible-builder
      tags: always
      ansible.builtin.pip:
        name: ansible-builder
        executable: pip3


  roles:
    - infra.ee_utilities.ee_builder
